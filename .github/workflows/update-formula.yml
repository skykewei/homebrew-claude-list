name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version info
        id: info
        run: |
          VERSION=${{ github.event.client_payload.version }}
          TAG=${{ github.event.client_payload.tag }}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "Updating to version $VERSION ($TAG)"

      - name: Download and calculate SHA256
        id: sha256
        run: |
          VERSION=${{ steps.info.outputs.VERSION }}

          # Download all assets and calculate SHA256
          for asset in claude-list-darwin-arm64 claude-list-darwin-amd64 claude-list-linux-amd64; do
            url="https://github.com/skykewei/claude-list/releases/download/v${VERSION}/${asset}.tar.gz"
            echo "Downloading $url..."
            curl -sL -o /tmp/${asset}.tar.gz "$url"
            sha256=$(sha256sum /tmp/${asset}.tar.gz | cut -d' ' -f1)
            echo "${asset}_sha256=$sha256" >> $GITHUB_OUTPUT
            echo "$asset: $sha256"
          done

      - name: Update formula
        run: |
          VERSION=${{ steps.info.outputs.VERSION }}

          cat > claude-list.rb << FORMULAEOF
      class ClaudeList < Formula
        desc "List Claude Code skills and MCP servers"
        homepage "https://github.com/skykewei/claude-list"
        version "${VERSION}"

        on_macos do
          if Hardware::CPU.arm?
            url "https://github.com/skykewei/claude-list/releases/download/v${VERSION}/claude-list-darwin-arm64.tar.gz"
            sha256 "${{ steps.sha256.outputs.claude-list-darwin-arm64_sha256 }}"
          else
            url "https://github.com/skykewei/claude-list/releases/download/v${VERSION}/claude-list-darwin-amd64.tar.gz"
            sha256 "${{ steps.sha256.outputs.claude-list-darwin-amd64_sha256 }}"
          end
        end

        on_linux do
          if Hardware::CPU.intel?
            url "https://github.com/skykewei/claude-list/releases/download/v${VERSION}/claude-list-linux-amd64.tar.gz"
            sha256 "${{ steps.sha256.outputs.claude-list-linux-amd64_sha256 }}"
          end
        end

        def install
          bin.install "claude-list"
        end

        test do
          system "#{bin}/claude-list", "--version"
        end
      end
      FORMULAEOF

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add claude-list.rb
          git commit -m "Update formula to version ${{ steps.info.outputs.VERSION }}"
          git push
